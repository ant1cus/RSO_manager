{% extends 'main/base.html' %}

{% block container %}
<div class="container-fluid d-grid gap-3 border border-1">
    <div class="mb-3 d-flex justify-content-around">
        <div style="flex: 1;">
            <form action="" method="post" id="simple_request">
                {% csrf_token %}
                <fieldset>
                    <legend align="center">Значения для поиска</legend>
                    {% for field in form %}
                        <div class="mt-3 flex-fill">
                            {{field}}
                        </div>
                    {% endfor %}
                    <button class="w-100 mb-2 btn btn-lg rounded-4 text-white mt-3" style="background-color: #134361;" type="button" id="simple_btn" onclick="finding_data()">Найти информацию</button>
                </fieldset>
            </form>
        </div>
        <div style="flex: 1;">
            <form class="rezultform">
                <fieldset>
                    <legend align="center">Результаты поиска</legend>
                        <div align="center" class="flex-fill" id="result_form">
                            <label id="inform_label">Введите значения для поиска и нажмите кнопку «Найти информацию»</label>
                        </div>
                </fieldset>
            </form>
        </div>
    </div>
</div>
<div id="notes">
</div>
<!-- Модальное окно -->
<div class="modal fade modal-xl" id="modal_window" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Создать заметку</h5>
      </div>
      <div class="modal-body">
          <div class="container-fluid" id="modal_div">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="mb-2 btn btn-lg rounded-4 text-white mt-3" style="background-color: #134361;" id="add_note_btn">Сохранить</button>
        <button type="button" class="mb-2 btn btn-lg rounded-4 text-white mt-3" style="background-color: #134361;" id="close_btn" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>
<!-- /Модальное окно -->
{% endblock %}
{% block javascript %}
<script>
    $("#add_note").on("click", function(){
        var myModal = new bootstrap.Modal(document.getElementById('modal_window'))
        $.ajax({
                url: "{% url 'notes' %}", //url страницы
                type: "GET", //метод отправки
                success: function(response) { //Данные отправлены успешно
                    console.log('success');
                    $('#modal_div').html(response);
                    }
                })
        myModal.show();
    })
// Модальное окно
    function display_form_errors(errors, form) {
        for (var k in errors) {
            console.log(k);
            console.log(errors[k]);
            form.find('input[name=' + k + ']').after('<div class="error">' + errors[k] + '</div>');
        }
    }

    $("#add_note_btn").on("click", function(){
        $.ajax({
                url: "{% url 'notes' %}", //url страницы
                data: $('#notes_form').serializeArray(),  // Сериализуем объект
                type: "POST", //метод отправки
                success: function(response) { //Данные отправлены успешно
                    $('#modal_div').html(response);
<!--                    $('#modal_window').find('.error').remove();-->
<!--                    var answer = $.parseJSON(response);-->
<!--                    if ('errors' in answer) {-->
<!--                        display_form_errors(answer['errors'], $('#modal_window'));-->
<!--                        }-->
                    },
                error: function(response) { // Данные не отправлены
                    console.log('ALARM!');
                    }
                })
    })
// /Модальное окно
    var list_element = [];

    function open_document(path) {
        console.log(path);
        console.log(list_element[path]);
        $.ajax({
                url: "{% url 'open_doc' %}", //url страницы
                data: {'file': list_element[path]},  // Сериализуем объект
                type: "GET", //метод отправки
                success: function(response) { //Данные отправлены успешно
                    console.log('success');
                    }
                })
    }

    function finding_data() {
        var myForm = $('#simple_request').serializeArray();
        var out = false;
        var dict_name = {'sn': 'серийный номер', 'secretnum': 'секретный номер', 'mark': 'марка'};
        for (key in myForm) { //проходим циклом по массиву объектов
            if (myForm[key].value && myForm[key].name != 'csrfmiddlewaretoken') {
                out = true;
                break;
            }
        }
        if (out) {
             $.ajax({
                url: "{% url 'finding' %}", //url страницы (finding)
                data: $('#simple_request').serializeArray(),  // Сериализуем объект
                type: "POST", //метод отправки
                success: function(response) { //Данные отправлены успешно
                    $("#result_form").html("");
                    var answer = $.parseJSON(response);
                    if ('errors' in answer) {
                        $('#result_form').append(answer['errors']);
                        }
                    else {
                        var name_req = '';
                        var number_element = 0;
                        for (name_val in answer) {
                            for (key in myForm) { //проходим циклом по массиву объектов
                                if (myForm[key].value == name_val) {
                                    name_req = dict_name[myForm[key].name];
                                    break;
                                    }
                                }
                            $('#result_form').append('Результаты поиска для ' + name_req + ' ' + name_val + ':');
                            var output = '<table border="1" align="center">';
                            var output_notes = '<table border="1" align="center">';
                            var output_notes_data = ['Запрос', 'Дата', 'ФИО', 'Организация', 'Телефон', 'Вопрос', 'Дополнения'];
                            output_notes += '<tr>';
                            output_notes_data.forEach(element => output_notes += '<th>' + element + '</th>');
                            output_notes += '</tr>';
                            const data = Object.entries(answer[name_val]);
                            var name_doc = ['Сопровод', 'Заключение', 'Протокол', 'Предписание'];
                            data.forEach(([key, value], index) => {
                                var header_table = '';
                                var var_table = '';
                                for (key_val in value) {
                                    if (key_val == 'Заметки') {
                                        if (value[key_val]) {
                                            output_notes += '<tr>';
                                            Object.entries(value[key_val]).forEach(([notes_key, notes_val]) => {
                                                console.log(notes_val);
                                                output_notes += '<tr>'
                                                for (nk in notes_val) {
                                                    if (notes_val[nk]) {
                                                        output_notes += '<td>' + notes_val[nk] + '</td>';
                                                    }
                                                    else {
                                                        output_notes += '<td>-</td>';
                                                    }
                                                }
                                                output_notes += '</tr>'
                                            })
                                            output_notes += '</tr>';
                                        }
                                    }
                                    else {
                                        header_table += '<th>' + key_val + '</th>';
                                        list_element[number_element] = value[key_val];
                                        if (name_doc.includes(key_val)) {
                                            if (value[key_val]) {
                                                var_table += `<td><button type="button" onclick="open_document(${number_element})">${key_val}</button></td>`;
                                            }
                                            else {
                                                var_table += `<td>Нет документа</td>`;
                                            }
                                        }
                                        else {
                                            var_table += '<td>' + value[key_val] + '</td>';
                                        }
                                        number_element += 1;
                                        }
                                    }
                                if (index == 0) {
                                    output += '<tr><th>№</th>' + header_table + '</tr>';
                                    }
                                output += '<tr><td>' + (index + 1) + '</td>' + var_table + '</tr>';
                                })
                            output_notes += '</table>';
                            output += '</table>';
                            $('#notes').html("");
                            if (Object.entries(answer[name_val])[0][1]['Заметки'].length > 0) {
                                console.log('есть заметка');
                                $('#notes').append(output_notes);
                            }
                            $('#result_form').append(output);
                        }
                    }
                },
                error: function(response) { // Данные не отправлены
                    $('#result_form').replaceWith($.parseJSON(response));
                    console.log('----------------------ALARM!--------------------------');
                }
            });
            }
        else
            alert('Заполните хотя бы один параметр для поиска!');
        }
</script>
{% endblock %}
